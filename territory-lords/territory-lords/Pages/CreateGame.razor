@page "/creategame"
@using Microsoft.Extensions.Logging
@using territory_lords.Data
@using territory_lords.Data.Cache
@using territory_lords.Data.Statics
@inject NavigationManager NavManager
@inject GameBoardCache BoardCache

<h3>CreateGame</h3>
@if(ShowError)
{
    <MudAlert Severity="Severity.Error" Variant="Variant.Filled">@string.Join(";", errorMessages)</MudAlert>
}

<form @onsubmit="BuildGame">
    <MudPaper>
        <MudTextField @bind-Value="@GameId" Label="The Game Id"   
        Required="true" RequiredError="GameId is required" Variant="Variant.Text"
        HelperText="This will be the name of your game and the URL to it as well" Margin="Margin.Dense"/>
    </MudPaper>
    <MudPaper>
        <label>World Size:</label>
        <MudNumericField @bind-Value="@Rows" Label="Height" Variant="Variant.Text" Min="@minColumnRows" Max="@maxColumnRows"/>
        <MudNumericField @bind-Value="@Columns" Label="Width" Variant="Variant.Text" Min="@minColumnRows" Max="@maxColumnRows"/>
    </MudPaper>
    <MudPaper>
        <label>Land Mass</label>
        <MudSlider @bind-value="@LandMass" Size="Size.Large" Step="1" TickMarks="true" TickMarkLabels="@landMassLabels" Min="@minRange" Max="@maxRange"/>
        <label>Islands</label>
        <input @bind=LandMass type="range" min="@minRange" max="@maxRange"/>
        <label>Continent</label>
    </MudPaper>
    <MudPaper>
        <label>Temperature</label>
        <label>Colder</label>
        <input @bind=Temperature type="range" min="@minRange" max="@maxRange"/>
        <label>Hotter</label>
    </MudPaper>
    <MudPaper>
        <label>Climate</label>
        <label>Arid</label>
        <input @bind=Climate type="range" min="@minRange" max="@maxRange"/>
        <label>Wet</label>
    </MudPaper>
    <MudPaper>
        <label>Age</label>
        <label>Mountainous</label>
        <input @bind=Age type="range" min="@minRange" max="@maxRange"/>
        <label>Hillanous</label>
    </MudPaper>
    <MudButton Variant="Variant.Filled" EndIcon="@Icons.Material.Filled.Create" Color="Color.Primary" ButtonType="ButtonType.Submit">Create Game</MudButton>
</form>

@code {
    private string GameId = "";
    private byte Columns;
    private byte Rows;
    private int LandMass;
    private byte Temperature;
    private byte Climate;
    private byte Age;
    private bool ShowError = false;
    private readonly byte minColumnRows = 20;//I think it would be fun to have small worlds like 10 x 10 but the world generation does not appreciate small worlds!
    private readonly byte maxColumnRows = 80;
    private readonly byte minRange = 0;
    private readonly byte maxRange = 2;
    private List<string> errorMessages = new List<string>();
    private string[] landMassLabels = new string[] { "Islands", "Normal", "Pangea" };

    protected override void OnInitialized()
    {
        //setup a bunch of random values to start the user off
        var random = new Random();
        GameId = Guid.NewGuid().ToString();
        Columns = (byte)random.Next(minColumnRows, maxColumnRows + 1);
        Rows = (byte)random.Next(minColumnRows, maxColumnRows + 1);
        LandMass = (byte)random.Next(minRange, maxRange + 1);
        Temperature = (byte)random.Next(minRange, maxRange + 1);
        Climate = (byte)random.Next(minRange, maxRange + 1);
        Age = (byte)random.Next(minRange, maxRange + 1);

    }
    private void BuildGame()
    {
        //need to reset showError at beginning
        ShowError = false;

        //make sure the inputs are valid to build a game board
        if (Columns < minColumnRows || Columns > maxColumnRows)
        {
            ShowError = true;
            errorMessages.Add($"Columns falls outside of range {minColumnRows} - {maxColumnRows}");
        }

        if (Rows < minColumnRows || Rows > maxColumnRows)
        {
            ShowError = true;
            errorMessages.Add($"Rows falls outside of range {minColumnRows} - {maxColumnRows}");
        }

        if (string.IsNullOrWhiteSpace(GameId))
        {
            ShowError = true;
            errorMessages.Add($"GameId cannot be blank");
        }

        //see if there is already a game at that address
        if (BoardCache.GetGameBoard(GameId) != null)
        {
            ShowError = true;
            errorMessages.Add($"There is already a Game with the Id of {GameId}");
        }

        if (ShowError)
            return;


        //create the game and save it
        var worldBuilder = new WorldBuilder(GameId, Rows, Columns, LandMass, Temperature, Climate, Age);
        var theGameBoard = worldBuilder.GenerateWorld();
        BoardCache.UpdateGameCache(theGameBoard);

        //redirect the player to the game address
        NavManager.NavigateTo($"/Map/{GameId}");

    }
}

